<!DOCTYPE html>
<html>

<head>
    <title>多模态数据采集系统</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .status-bar {
            display: none;
            /* 隐藏原状态栏 */
        }

        /* 设备展示区样式 */
        .devices-showcase {
            display: none;
            /* 隐藏原设备展示区 */
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .upper-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 上半部分平均分成两列 */
            gap: 20px;
            height: 480px;
            /* 固定上半部分高度 */
        }

        .lower-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .camera-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* 设备信息区域 */
        .device-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .device-image-small {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 15px;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .device-status-text {
            font-size: 14px;
            color: #666;
        }

        .angles-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .angles-content {
            display: flex;
            height: calc(100% - 50px);
            gap: 15px;
            align-items: stretch;
            /* 确保子元素拉伸到相同高度 */
        }

        .skeleton-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #e9ecef;
            overflow: hidden;
            height: 100%;
            /* 确保高度填充父容器 */
        }

        .skeleton-image {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            margin: 0 auto;
        }

        .finger-data {
            flex: 1.2;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            overflow-y: auto;
            padding-right: 5px;
            align-content: flex-start;
            justify-content: space-between;
            height: 100%;
            /* 确保与图片容器等高 */
        }

        #camera-feed {
            width: 100%;
            height: calc(100% - 40px);
            /* 减去标题高度 */
            object-fit: contain;
            border-radius: 4px;
        }

        .emg-container {
            padding: 20px;
        }

        .emg-charts-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            /* 8个通道横向排列 */
            gap: 10px;
            margin-top: 15px;
        }

        .emg-chart {
            height: 200px;
            /* 调整EMG图表高度 */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
        }

        .device-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
            margin-right: 10px;
        }

        .data-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }

        .data-indicator.active {
            background-color: #28a745;
        }

        .data-indicator.inactive {
            background-color: #dc3545;
        }

        .finger-section {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 12px;
            width: calc(50% - 4px);
            box-sizing: border-box;
            margin-bottom: 6px;
        }

        /* 针对拇指的特殊处理，因为数据较少 */
        .finger-section.thumb {
            width: calc(50% - 4px);
        }

        /* 针对小指的特殊处理，确保在底部正确显示 */
        .finger-section.pinky {
            width: calc(50% - 4px);
        }

        /* 针对食指、中指和无名指的处理 */
        .finger-section.index,
        .finger-section.middle,
        .finger-section.ring {
            width: calc(50% - 4px);
        }

        .finger-section h4 {
            margin: 0 0 4px 0;
            color: #333;
            font-size: 13px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 2px;
        }

        .joint-angle {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 11px;
            border-bottom: 1px solid #eee;
        }

        .joint-angle span:last-child {
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        button.recording {
            background-color: #dc3545;
        }

        .reset-btn {
            background-color: #6c757d;
        }

        .reset-btn:hover {
            background-color: #545b62;
        }

        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .emg-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* 添加滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 新增样式 */
        .stats-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            font-weight: bold;
            margin-right: 5px;
            color: #495057;
        }

        .stat-value {
            color: #007bff;
        }

        .stat-value.warning {
            color: #ffc107;
        }

        .stat-value.danger {
            color: #dc3545;
        }

        .emg-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mode-btn {
            padding: 5px 10px;
            font-size: 12px;
            background: #e9ecef;
            color: #495057;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
        }

        .camera-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* 系统控制区域 */
        .system-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .system-status {
            margin-bottom: 15px;
            text-align: center;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        /* 实验配置面板样式 */
        .experiment-setup {
            margin-bottom: 20px;
        }

        .setup-content {
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .action-category {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .action-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .action-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .action-item label {
            margin-left: 10px;
            flex-grow: 1;
        }

        .current-action {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-action-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
        }

        .trial-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .trial-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
        }

        .trial-dot.completed {
            background: var(--primary-color);
        }

        .trial-dot.current {
            background: var(--warning-color);
            animation: pulse 1s infinite;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: #333;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 宽高比 */
            background: #000;
            border-radius: 4px;
            overflow: hidden;
        }

        #demo-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .demo-instructions {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
        }

        /* 演示按钮样式 */
        .demo-btn {
            padding: 4px 8px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .demo-btn:hover {
            background-color: #138496;
            transform: translateY(-1px);
        }

        .demo-btn:active {
            transform: translateY(0);
        }

        /* 加载状态样式 */
        .loading .video-container::after {
            content: '视频加载中...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }

        .error .video-container::after {
            content: '视频加载失败';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #dc3545;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>多模态数据采集系统</h1>
    </div>

    <!-- 在系统控制区域之前添加以下内容 -->
    <div class="experiment-setup" id="experiment-setup">
        <div class="panel">
            <div class="section-header">
                <div class="section-title">实验配置</div>
                <button class="btn btn-primary" id="toggle-setup-btn" onclick="toggleSetupPanel()">
                    显示配置
                </button>
            </div>

            <div class="setup-content" id="setup-content" style="display: none;">
                <!-- 实验参数配置 -->
                <div class="config-section">
                    <h3>基本参数设置</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="subject-id">受试者编号</label>
                            <input type="text" id="subject-id" class="form-control" placeholder="例如：S001" required>
                        </div>

                        <div class="form-group">
                            <label for="dominant-hand">惯用手</label>
                            <select id="dominant-hand" class="form-control" required>
                                <option value="">请选择</option>
                                <option value="right">右手</option>
                                <option value="left">左手</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="action-duration">动作持续时间(秒)</label>
                            <input type="number" id="action-duration" class="form-control" min="5" max="10" value="8"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="repeat-times">重复次数</label>
                            <input type="number" id="repeat-times" class="form-control" min="3" max="5" value="3"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="rest-duration">休息时间(秒)</label>
                            <input type="number" id="rest-duration" class="form-control" min="3" max="5" value="4"
                                required>
                        </div>
                    </div>
                </div>

                <!-- 动作列表配置 -->
                <div class="config-section">
                    <h3>动作列表配置</h3>
                    <div class="action-categories">
                        <!-- 细粒度手部动作 -->
                        <div class="action-category">
                            <h4>细粒度手部动作</h4>
                            <div class="action-list" id="fine-actions">
                                <!-- 动作列表将通过JavaScript动态生成 -->
                            </div>
                        </div>

                        <!-- 任务导向手部动作 -->
                        <div class="action-category">
                            <h4>任务导向手部动作</h4>
                            <div class="action-list" id="task-actions">
                                <!-- 动作列表将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 实验进度显示 -->
                <div class="config-section" id="experiment-progress" style="display: none;">
                    <h3>实验进度</h3>
                    <div class="current-action">
                        <h4>当前动作</h4>
                        <div id="current-action-display" class="current-action-text">等待开始...</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="experiment-progress-bar"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="action-count">0/0 动作</span>
                        <span id="trial-count">0/0 次</span>
                    </div>
                    <div class="trial-dots" id="trial-dots"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统控制区域 -->
    <div class="system-controls">
        <div class="system-status">
            <div id="status" class="status">系统状态: 初始化中...</div>
            <div id="myo-status" class="status">Myo状态: 检查中...</div>
        </div>
        <div class="control-buttons">
            <button id="recordBtn" onclick="toggleRecording()">开始记录</button>
            <button onclick="resetData()" class="reset-btn">重置数据</button>
            <button onclick="resetMyoConnection()" class="reset-btn">重置Myo连接</button>
        </div>
    </div>

    <div class="main-container">
        <div class="upper-section">
            <div class="camera-container">
                <div class="section-header">
                    <div class="section-title">
                        <img src="{{ url_for('static', filename='images/realsense_camera.png') }}" alt="RealSense相机"
                            class="device-icon">
                        手部追踪
                        <span class="data-indicator" id="camera-indicator"></span>
                        <span class="device-status-text" id="realsense-connection-text"
                            style="margin-left: 8px; font-size: 12px; color: #666;"></span>
                    </div>
                    <div class="camera-stats">
                        <span class="stat-item">
                            <span class="stat-label">帧率:</span>
                            <span class="stat-value" id="camera-fps">0 FPS</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">总帧数:</span>
                            <span class="stat-value" id="camera-total-frames">0</span>
                        </span>
                    </div>
                </div>
                <img id="camera-feed" src="" alt="Camera Feed">
            </div>

            <div class="angles-container">
                <div class="section-header">
                    <div class="section-title">
                        手部关节角度数据
                        <span class="data-indicator" id="angles-indicator"></span>
                    </div>
                </div>
                <div class="angles-content">
                    <div class="skeleton-container">
                        <img src="{{ url_for('static', filename='images/hand_skeleton.png') }}" alt="手部骨骼"
                            class="skeleton-image">
                    </div>
                    <div class="finger-data" id="angles-display"></div>
                </div>
            </div>
        </div>

        <div class="lower-section">
            <div class="section-header">
                <div class="section-title">
                    <img src="{{ url_for('static', filename='images/myo_armband.png') }}" alt="Myo臂环"
                        class="device-icon">
                    EMG数据
                    <span class="data-indicator" id="emg-indicator"></span>
                    <span class="device-status-text" id="myo-connection-text"
                        style="margin-left: 8px; font-size: 12px; color: #666;"></span>
                </div>
                <!-- EMG模式选择器 -->
                <div class="emg-mode-selector">
                    <button class="mode-btn active" id="filtered-mode-btn"
                        onclick="switchEMGMode('filtered')">滤波后数据</button>
                    <button class="mode-btn" id="raw-mode-btn" onclick="switchEMGMode('raw')">原始数据</button>
                </div>
            </div>

            <!-- EMG统计信息 -->
            <div class="stats-container">
                <div class="stat-item">
                    <span class="stat-label">帧率:</span>
                    <span class="stat-value" id="frame-rate">0 FPS</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">总帧数:</span>
                    <span class="stat-value" id="total-frames">0</span>
                </div>
            </div>

            <div class="emg-charts-grid">
                <div class="emg-chart" id="emg-chart-1"></div>
                <div class="emg-chart" id="emg-chart-2"></div>
                <div class="emg-chart" id="emg-chart-3"></div>
                <div class="emg-chart" id="emg-chart-4"></div>
                <div class="emg-chart" id="emg-chart-5"></div>
                <div class="emg-chart" id="emg-chart-6"></div>
                <div class="emg-chart" id="emg-chart-7"></div>
                <div class="emg-chart" id="emg-chart-8"></div>
            </div>
        </div>
    </div>

    <!-- 在 body 标签内，main-container div 之前添加模态框结构 -->
    <div id="demo-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="demo-title">动作演示</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="video-container">
                    <video id="demo-video" controls>
                        您的浏览器不支持视频播放。
                    </video>
                </div>
                <div class="demo-instructions" id="demo-instructions">
                    <!-- 动作说明将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        class MultiModalCollector {
            constructor() {
                this.isRunning = true;
                this.isRecording = false;
                this.recordedData = [];
                this.MAX_POINTS = 100;
                this.emgDataPoints = Array(8).fill().map(() => Array(this.MAX_POINTS).fill(0));
                this.rawEmgDataPoints = Array(8).fill().map(() => Array(this.MAX_POINTS).fill(0));
                this.filteredEmgDataPoints = Array(8).fill().map(() => Array(this.MAX_POINTS).fill(0));
                this.currentEMGMode = 'filtered'; // 默认显示滤波后数据
                this.initCharts();
                this.fetchData();
                this.checkMyoStatus();
                this.updateDeviceIndicators(); // 添加设备状态指示器更新
                this.initExperimentSetup();
            }

            initCharts() {
                for (let i = 0; i < 8; i++) {
                    const trace = {
                        y: this.filteredEmgDataPoints[i],
                        mode: 'lines',
                        line: { color: `hsl(${i * 45}, 70%, 50%)` },
                        name: `通道 ${i + 1}`
                    };

                    const layout = {
                        title: `EMG ${i + 1}`,
                        height: 200,
                        margin: { t: 25, b: 20, l: 30, r: 20 },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        yaxis: {
                            range: [-128, 128],
                            showgrid: true,
                            gridcolor: '#eee',
                            tickfont: { size: 10 }
                        },
                        xaxis: {
                            showgrid: false,
                            showticklabels: false
                        },
                        font: { size: 10 }
                    };

                    Plotly.newPlot(`emg-chart-${i + 1}`, [trace], layout, {
                        displayModeBar: false,
                        responsive: true
                    });
                }
            }

            updateEMGCharts(emgData) {
                const rawData = emgData.raw_emg;
                const filteredData = emgData.filtered_emg;

                // 更新数据缓冲区
                for (let i = 0; i < 8; i++) {
                    this.rawEmgDataPoints[i].shift();
                    this.rawEmgDataPoints[i].push(rawData[i]);

                    this.filteredEmgDataPoints[i].shift();
                    this.filteredEmgDataPoints[i].push(filteredData[i]);

                    // 根据当前模式选择显示的数据
                    const displayData = this.currentEMGMode === 'raw' ?
                        this.rawEmgDataPoints[i] : this.filteredEmgDataPoints[i];

                    Plotly.update(`emg-chart-${i + 1}`, {
                        y: [displayData]
                    }, {}, { duration: 0 });
                }
            }

            switchEMGMode(mode) {
                this.currentEMGMode = mode;

                // 更新按钮状态
                document.getElementById('raw-mode-btn').classList.toggle('active', mode === 'raw');
                document.getElementById('filtered-mode-btn').classList.toggle('active', mode === 'filtered');

                // 更新图表显示
                for (let i = 0; i < 8; i++) {
                    const displayData = mode === 'raw' ?
                        this.rawEmgDataPoints[i] : this.filteredEmgDataPoints[i];

                    Plotly.update(`emg-chart-${i + 1}`, {
                        y: [displayData]
                    }, {}, { duration: 0 });
                }
            }

            async checkMyoStatus() {
                if (!this.isRunning) return;

                try {
                    const response = await fetch('/myo_status');
                    const data = await response.json();

                    if (data.status === 'success') {
                        const statusText = data.connected ?
                            (data.synced ? '已连接且同步' : '已连接待同步') :
                            '未连接';
                        this.updateMyoStatus(statusText, !data.connected);

                        // 更新EMG统计信息
                        this.updateEMGStats(data);
                    }
                } catch (error) {
                    this.updateMyoStatus('状态检查失败', true);
                }

                setTimeout(() => this.checkMyoStatus(), 1000);
            }

            updateEMGStats(data) {
                // 更新帧率
                const frameRateElement = document.getElementById('frame-rate');
                frameRateElement.textContent = `${data.frame_rate.toFixed(1)} FPS`;

                // 根据帧率设置颜色
                if (data.frame_rate < 100) {
                    frameRateElement.className = 'stat-value warning';
                } else if (data.frame_rate < 50) {
                    frameRateElement.className = 'stat-value danger';
                } else {
                    frameRateElement.className = 'stat-value';
                }

                // 更新总帧数
                document.getElementById('total-frames').textContent = data.total_frames;

            }

            updateMyoStatus(message, isError = false) {
                const status = document.getElementById('myo-status');
                status.textContent = 'Myo状态: ' + message;
                status.className = `status ${isError ? 'error' : 'success'}`;
            }

            updateStatus(message, isError = false) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${isError ? 'error' : 'success'}`;
            }

            updateAngles(handData) {
                if (!handData || Object.keys(handData).length === 0) {
                    document.getElementById('angles-display').innerHTML =
                        '<div class="finger-section">未检测到手部</div>';
                    return;
                }

                const display = document.getElementById('angles-display');
                display.innerHTML = '';

                // 调整手指顺序，使布局更加均衡
                const fingers = ['thumb', 'index', 'middle', 'ring', 'pinky'];
                const movements = ['flexion', 'abduction'];

                // 创建一个包装容器来控制整体布局
                const wrapper = document.createElement('div');
                wrapper.style.width = '100%';
                wrapper.style.display = 'flex';
                wrapper.style.flexWrap = 'wrap';
                wrapper.style.justifyContent = 'space-between';
                wrapper.style.alignItems = 'flex-start';

                // 创建上排容器（拇指、食指）
                const topRow = document.createElement('div');
                topRow.style.width = '100%';
                topRow.style.display = 'flex';
                topRow.style.justifyContent = 'space-between';
                topRow.style.marginBottom = '6px';

                // 创建中排容器（中指、无名指）
                const middleRow = document.createElement('div');
                middleRow.style.width = '100%';
                middleRow.style.display = 'flex';
                middleRow.style.justifyContent = 'space-between';
                middleRow.style.marginBottom = '6px';

                // 创建下排容器（小指）
                const bottomRow = document.createElement('div');
                bottomRow.style.width = '100%';
                bottomRow.style.display = 'flex';
                bottomRow.style.justifyContent = 'center';

                // 将手指分配到不同行
                fingers.forEach((finger, index) => {
                    const section = document.createElement('div');
                    section.className = `finger-section ${finger}`;
                    let html = `<h4>${this.getFingerName(finger)}</h4>`;

                    ['mcp', 'pip', 'dip'].forEach(joint => {
                        movements.forEach(movement => {
                            const angleKey = `${finger}_${joint}_${movement}`;
                            if (angleKey in handData) {
                                const angle = handData[angleKey];
                                const color = movement === 'flexion' ? '#28a745' : '#007bff';
                                html += `
                                    <div class="joint-angle">
                                        <span>${this.getJointName(joint)} ${this.getMovementName(movement)}</span>
                                        <span style="color: ${color}">${angle.toFixed(1)}°</span>
                                    </div>
                                `;
                            }
                        });
                    });

                    section.innerHTML = html;

                    // 根据手指类型分配到不同行
                    if (finger === 'thumb' || finger === 'index') {
                        topRow.appendChild(section);
                    } else if (finger === 'middle' || finger === 'ring') {
                        middleRow.appendChild(section);
                    } else if (finger === 'pinky') {
                        bottomRow.appendChild(section);
                    }
                });

                // 将所有行添加到主容器
                wrapper.appendChild(topRow);
                wrapper.appendChild(middleRow);
                wrapper.appendChild(bottomRow);

                // 将主容器添加到显示区域
                display.appendChild(wrapper);
            }

            getFingerName(finger) {
                return {
                    'thumb': '拇指',
                    'index': '食指',
                    'middle': '中指',
                    'ring': '无名指',
                    'pinky': '小指'
                }[finger] || finger;
            }

            getJointName(joint) {
                return {
                    'mcp': 'MCP关节',
                    'pip': 'PIP关节',
                    'dip': 'DIP关节'
                }[joint] || joint;
            }

            getMovementName(movement) {
                return {
                    'flexion': '屈曲',
                    'abduction': '外展'
                }[movement] || movement;
            }

            updateDataIndicators(data) {
                // 更新相机数据指示器
                const cameraIndicator = document.getElementById('camera-indicator');
                cameraIndicator.className = 'data-indicator ' +
                    (data.frame ? 'active' : 'inactive');

                // 更新EMG数据指示器
                const emgIndicator = document.getElementById('emg-indicator');
                const hasEmgData = data.emg_data.raw_emg && data.emg_data.raw_emg.some(v => v !== 0);
                emgIndicator.className = 'data-indicator ' + (hasEmgData ? 'active' : 'inactive');

                // 更新角度数据指示器
                const anglesIndicator = document.getElementById('angles-indicator');
                anglesIndicator.className = 'data-indicator ' +
                    (Object.keys(data.hand_data).length > 0 ? 'active' : 'inactive');
            }

            async fetchData() {
                if (!this.isRunning) return;

                try {
                    const response = await fetch('/get_data');
                    const data = await response.json();

                    if (data.status === 'success') {
                        // 添加调试输出，查看手部数据结构
                        console.log("Hand data:", data.hand_data);

                        // 更新数据指示器
                        this.updateDataIndicators(data);

                        // 更新显示内容
                        if (data.frame) {
                            document.getElementById('camera-feed').src =
                                'data:image/jpeg;base64,' + data.frame;
                        }

                        if (data.emg_data) {
                            this.updateEMGCharts(data.emg_data);
                        }

                        if (data.hand_data) {
                            this.updateAngles(data.hand_data);
                        }

                        // 更新相机统计信息
                        this.updateCameraStats(data);

                        if (this.isRecording) {
                            this.recordedData.push({
                                timestamp: data.timestamp,
                                emg_data: data.emg_data,
                                hand_data: data.hand_data
                            });
                        }

                        this.updateStatus(
                            this.isRecording ? '正在记录数据...' : '数据接收正常'
                        );
                    } else {
                        throw new Error(data.message || '数据获取失败');
                    }
                } catch (error) {
                    console.error('数据获取错误:', error);
                    this.updateStatus('数据获取错误: ' + error.message, true);
                }

                requestAnimationFrame(() => this.fetchData());
            }

            updateCameraStats(data) {
                try {
                    // 更新相机帧率
                    if (data.camera_fps !== undefined) {
                        const camerafpsElement = document.getElementById('camera-fps');
                        if (camerafpsElement) {
                            camerafpsElement.textContent = `${data.camera_fps} FPS`;

                            // 根据帧率设置颜色
                            if (data.camera_fps < 20) {
                                camerafpsElement.className = 'stat-value danger';
                            } else if (data.camera_fps < 25) {
                                camerafpsElement.className = 'stat-value warning';
                            } else {
                                camerafpsElement.className = 'stat-value';
                            }
                        }
                    }

                    // 更新相机总帧数
                    if (data.camera_total_frames !== undefined) {
                        const cameraTotalFramesElement = document.getElementById('camera-total-frames');
                        if (cameraTotalFramesElement) {
                            cameraTotalFramesElement.textContent = data.camera_total_frames;
                        }
                    }
                } catch (error) {
                    console.error('更新相机统计信息错误:', error);
                }
            }

            toggleRecording() {
                this.isRecording = !this.isRecording;
                const btn = document.getElementById('recordBtn');

                if (this.isRecording) {
                    // 开始记录时，获取基本信息
                    const subjectId = document.getElementById('subject-id').value;
                    const dominantHand = document.getElementById('dominant-hand').value;

                    if (!subjectId || !dominantHand) {
                        alert('请先填写受试者信息（编号和惯用手）');
                        this.isRecording = false;
                        return;
                    }

                    // 发送开始记录请求
                    fetch('/record_action', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subject_id: subjectId,
                            dominant_hand: dominantHand,
                            action: 'manual_recording', // 手动记录标记
                            trial: Date.now() // 使用时间戳作为试次标识
                        })
                    });

                    btn.textContent = '停止记录';
                    btn.classList.add('recording');
                } else {
                    // 发送停止记录请求
                    fetch('/stop_recording', {
                        method: 'POST'
                    }).then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                this.updateStatus('数据已保存为HDF5格式');
                            } else {
                                this.updateStatus('数据保存失败: ' + data.message, true);
                            }
                        });

                    btn.textContent = '开始记录';
                    btn.classList.remove('recording');
                }
            }

            resetData() {
                this.recordedData = [];
                this.updateStatus('数据已重置');
            }

            resetMyoConnection() {
                // 发送重置Myo连接的请求
                fetch('/reset_myo', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.updateStatus('Myo连接已重置');
                        } else {
                            this.updateStatus('Myo连接重置失败: ' + data.message, true);
                        }
                    })
                    .catch(error => {
                        this.updateStatus('Myo连接重置请求失败: ' + error.message, true);
                    });
            }

            stop() {
                this.isRunning = false;
                if (this.isRecording) {
                    this.toggleRecording();
                }
            }

            // 添加设备状态指示器更新方法
            updateDeviceIndicators() {
                // 定期更新设备指示器状态
                setInterval(() => {
                    // 更新Myo指示器
                    const myoConnected = document.getElementById('myo-status').classList.contains('success');
                    const myoText = document.getElementById('myo-connection-text');

                    if (myoConnected) {
                        myoText.textContent = '已连接';
                        document.getElementById('emg-indicator').style.backgroundColor = '#28a745'; // 绿色
                    } else {
                        myoText.textContent = '未连接';
                        document.getElementById('emg-indicator').style.backgroundColor = '#dc3545'; // 红色
                    }

                    // 更新RealSense指示器
                    const realsenseConnected = document.getElementById('camera-indicator').classList.contains('active');
                    const realsenseText = document.getElementById('realsense-connection-text');

                    if (realsenseConnected) {
                        realsenseText.textContent = '已连接';
                        document.getElementById('camera-indicator').style.backgroundColor = '#28a745'; // 绿色
                    } else {
                        realsenseText.textContent = '未连接';
                        document.getElementById('camera-indicator').style.backgroundColor = '#dc3545'; // 红色
                    }
                }, 1000);
            }

            initExperimentSetup() {
                // 初始化动作列表
                this.initActionLists();

                // 绑定实验控制事件
                document.getElementById('toggle-setup-btn').addEventListener('click', () => {
                    const setupContent = document.getElementById('setup-content');
                    const isHidden = setupContent.style.display === 'none';
                    setupContent.style.display = isHidden ? 'block' : 'none';
                    document.getElementById('toggle-setup-btn').textContent =
                        isHidden ? '隐藏配置' : '显示配置';
                });
            }

            initActionLists() {
                // 细粒度动作列表及其说明
                const fineActions = [
                    {
                        name: '握拳（完全闭合）',
                        video: 'fist.mp4',
                        instructions: '1. 从手掌完全伸展开始\n2. 缓慢收拢所有手指\n3. 最终形成完全握拳状态\n4. 保持5秒'
                    },
                    {
                        name: '手掌完全伸展',
                        video: 'palm_extension.mp4',
                        instructions: '1. 手指自然伸直\n2. 掌心完全展开\n3. 手指间适度分开\n4. 保持5秒'
                    },
                    // ... 其他动作配置
                ];

                // 任务导向动作列表及其说明
                const taskActions = [
                    {
                        name: '模拟拿杯子',
                        video: 'cup_grasp.mp4',
                        instructions: '1. 手掌自然张开\n2. 做出抓握杯子的动作\n3. 保持自然抓握姿势\n4. 维持5秒'
                    },
                    // ... 其他动作配置
                ];

                this.createActionList('fine-actions', fineActions);
                this.createActionList('task-actions', taskActions);
            }

            createActionList(containerId, actions) {
                const container = document.getElementById(containerId);
                container.innerHTML = actions.map((action, index) => `
                    <div class="action-item">
                        <input type="checkbox" id="${containerId}-${index}" checked>
                        <label for="${containerId}-${index}">${action.name}</label>
                        <button class="demo-btn" onclick="showActionDemo('${action.name}', '${action.video}', \`${action.instructions}\`)">
                            <i class="fas fa-play"></i> 演示
                        </button>
                    </div>
                `).join('');
            }

            startExperiment() {
                // 验证实验配置
                if (!this.validateExperimentConfig()) {
                    return;
                }

                // 显示实验进度面板
                document.getElementById('experiment-progress').style.display = 'block';

                // 初始化实验状态
                this.experimentState = {
                    currentActionIndex: 0,
                    currentTrialIndex: 0,
                    totalActions: this.getSelectedActions().length,
                    totalTrials: parseInt(document.getElementById('repeat-times').value),
                    actionDuration: parseInt(document.getElementById('action-duration').value),
                    restDuration: parseInt(document.getElementById('rest-duration').value)
                };

                // 更新试次指示器
                this.updateTrialDots();

                // 开始第一个动作
                this.startNextAction();
            }

            validateExperimentConfig() {
                const subjectId = document.getElementById('subject-id').value;
                const dominantHand = document.getElementById('dominant-hand').value;

                if (!subjectId || !dominantHand) {
                    alert('请填写完整的受试者信息');
                    return false;
                }

                const selectedActions = this.getSelectedActions();
                if (selectedActions.length === 0) {
                    alert('请至少选择一个动作');
                    return false;
                }

                return true;
            }

            getSelectedActions() {
                const selectedActions = [];
                document.querySelectorAll('.action-item input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedActions.push(checkbox.nextElementSibling.textContent);
                });
                return selectedActions;
            }

            updateTrialDots() {
                const dotsContainer = document.getElementById('trial-dots');
                dotsContainer.innerHTML = '';

                for (let i = 0; i < this.experimentState.totalTrials; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'trial-dot';
                    if (i < this.experimentState.currentTrialIndex) {
                        dot.classList.add('completed');
                    } else if (i === this.experimentState.currentTrialIndex) {
                        dot.classList.add('current');
                    }
                    dotsContainer.appendChild(dot);
                }
            }

            startNextAction() {
                const actions = this.getSelectedActions();
                if (this.experimentState.currentActionIndex >= actions.length) {
                    this.finishExperiment();
                    return;
                }

                const currentAction = actions[this.experimentState.currentActionIndex];
                document.getElementById('current-action-display').textContent = currentAction;

                // 更新进度
                this.updateExperimentProgress();

                // 开始记录数据
                this.startRecording();

                // 设置动作完成计时器
                setTimeout(() => {
                    this.stopRecording();
                    this.startRest();
                }, this.experimentState.actionDuration * 1000);
            }

            startRest() {
                document.getElementById('current-action-display').textContent = '休息中...';

                setTimeout(() => {
                    this.experimentState.currentTrialIndex++;
                    if (this.experimentState.currentTrialIndex >= this.experimentState.totalTrials) {
                        this.experimentState.currentTrialIndex = 0;
                        this.experimentState.currentActionIndex++;
                    }
                    this.updateTrialDots();
                    this.startNextAction();
                }, this.experimentState.restDuration * 1000);
            }

            updateExperimentProgress() {
                const progress = (this.experimentState.currentActionIndex * this.experimentState.totalTrials +
                    this.experimentState.currentTrialIndex) /
                    (this.experimentState.totalActions * this.experimentState.totalTrials) * 100;

                document.getElementById('experiment-progress-bar').style.width = `${progress}%`;
                document.getElementById('action-count').textContent =
                    `${this.experimentState.currentActionIndex + 1}/${this.experimentState.totalActions} 动作`;
                document.getElementById('trial-count').textContent =
                    `${this.experimentState.currentTrialIndex + 1}/${this.experimentState.totalTrials} 次`;
            }

            finishExperiment() {
                alert('实验完成！');
                document.getElementById('current-action-display').textContent = '实验已完成';
                this.stopRecording();
            }
        }

        // 创建全局采集器实例
        const collector = new MultiModalCollector();

        // 控制函数
        function toggleRecording() {
            collector.toggleRecording();
        }

        function resetData() {
            collector.resetData();
        }

        function resetMyoConnection() {
            collector.resetMyoConnection();
        }

        function switchEMGMode(mode) {
            collector.switchEMGMode(mode);
        }

        // 页面关闭时清理
        window.addEventListener('beforeunload', () => {
            collector.stop();
        });

        // 动作演示相关函数
        function showActionDemo(actionName, videoFile, instructions) {
            const modal = document.getElementById('demo-modal');
            const video = document.getElementById('demo-video');
            const title = document.getElementById('demo-title');
            const instructionsElement = document.getElementById('demo-instructions');

            // 重置状态
            modal.classList.remove('loading', 'error');
            modal.classList.add('loading');

            // 设置内容
            title.textContent = `动作演示 - ${actionName}`;
            video.src = `/static/videos/${videoFile}`;
            instructionsElement.innerHTML = `
                <h4>动作要领：</h4>
                <pre>${instructions}</pre>
            `;

            // 显示模态框
            modal.style.display = 'block';

            // 视频事件处理
            video.addEventListener('loadstart', () => {
                modal.classList.add('loading');
            });

            video.addEventListener('canplay', () => {
                modal.classList.remove('loading');
                video.play().catch(e => console.log('自动播放失败:', e));
            });

            video.addEventListener('error', () => {
                modal.classList.remove('loading');
                modal.classList.add('error');
                console.error('视频加载失败');
            });
        }

        // 关闭模态框处理
        document.querySelector('.close-modal').onclick = closeModal;
        window.onclick = function (event) {
            const modal = document.getElementById('demo-modal');
            if (event.target == modal) {
                closeModal();
            }
        };
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        function closeModal() {
            const modal = document.getElementById('demo-modal');
            const video = document.getElementById('demo-video');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
                video.pause();
                video.currentTime = 0;
                modal.classList.remove('loading', 'error');
            }
        }
    </script>
</body>

</html>